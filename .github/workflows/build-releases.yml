name: Build Releases

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="dev-$(date +%Y%m%d)"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyQt6 pyinstaller
          
      - name: Build Linux executable
        run: |
          pyinstaller --onefile --windowed --name winvora \
            --add-data "src:src" \
            --hidden-import PyQt6 \
            winvora.py
          
          # Rename to versioned filename
          mv dist/winvora dist/winvora-${{ steps.version.outputs.VERSION }}-linux-x86_64
      
      - name: Create AppImage
        run: |
          # Download AppImage tools
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # Copy executable
          cp dist/winvora-${{ steps.version.outputs.VERSION }}-linux-x86_64 AppDir/usr/bin/winvora
          
          # Create desktop file
          cat > AppDir/winvora.desktop << EOF
          [Desktop Entry]
          Name=Winvora
          Exec=winvora
          Icon=winvora
          Type=Application
          Categories=Utility;
          Comment=Wine compatibility layer manager
          EOF
          
          # Copy desktop file
          cp AppDir/winvora.desktop AppDir/usr/share/applications/
          
          # Create icon (placeholder if not exists)
          touch AppDir/usr/share/icons/hicolor/256x256/apps/winvora.png
          
          # Build AppImage
          ./appimagetool-x86_64.AppImage AppDir winvora-${{ steps.version.outputs.VERSION }}-linux-x86_64.AppImage || true
      
      - name: Create DEB package
        run: |
          mkdir -p winvora-deb/DEBIAN
          mkdir -p winvora-deb/usr/bin
          mkdir -p winvora-deb/usr/share/applications
          mkdir -p winvora-deb/usr/share/doc/winvora
          
          # Copy executable
          cp dist/winvora-${{ steps.version.outputs.VERSION }}-linux-x86_64 winvora-deb/usr/bin/winvora
          chmod +x winvora-deb/usr/bin/winvora
          
          # Create control file
          cat > winvora-deb/DEBIAN/control << EOF
          Package: winvora
          Version: ${{ steps.version.outputs.VERSION }}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Winvora Team
          Description: Wine compatibility layer manager
           A cross-platform application for running Windows software using Wine.
          EOF
          
          # Create desktop file
          cat > winvora-deb/usr/share/applications/winvora.desktop << EOF
          [Desktop Entry]
          Name=Winvora
          Exec=/usr/bin/winvora
          Icon=winvora
          Type=Application
          Categories=Utility;
          Comment=Wine compatibility layer manager
          EOF
          
          # Copy documentation
          cp README.md winvora-deb/usr/share/doc/winvora/
          cp LICENSE winvora-deb/usr/share/doc/winvora/
          
          # Build DEB
          dpkg-deb --build winvora-deb winvora-${{ steps.version.outputs.VERSION }}-linux-amd64.deb
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            dist/winvora-*-linux-x86_64
            winvora-*-linux-x86_64.AppImage
            winvora-*-linux-amd64.deb

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="dev-$(date +%Y%m%d)"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyQt6 pyinstaller py2app
      
      - name: Build macOS app bundle
        run: |
          # Clean any previous builds
          rm -rf build dist *.spec
          
          # Build with PyInstaller (onedir mode for macOS)
          pyinstaller --onedir --windowed --name Winvora \
            --add-data "src:src" \
            --hidden-import PyQt6 \
            --osx-bundle-identifier com.winvora.app \
            winvora.py
      
      - name: Create DMG
        run: |
          # Create DMG structure
          mkdir -p dmg_temp
          cp -r "dist/Winvora.app" dmg_temp/ || cp -r dist/Winvora dmg_temp/Winvora.app
          
          # Create Applications symlink
          ln -s /Applications dmg_temp/Applications
          
          # Create DMG
          hdiutil create -volname "Winvora" -srcfolder dmg_temp -ov -format UDZO winvora-${{ steps.version.outputs.VERSION }}-macos.dmg
      
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: |
            winvora-*-macos.dmg

  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="dev-$(date +%Y%m%d)"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Android SDK components
        run: |
          sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0" "ndk;25.2.9519653"
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libffi-dev python3-dev \
            git zip unzip wget autoconf libtool pkg-config zlib1g-dev \
            libncurses5-dev libncursesw5-dev cmake
          
          python -m pip install --upgrade pip
          pip install --upgrade buildozer cython==0.29.33
      
      - name: Build Android APK
        run: |
          cd src/apps/android
          
          # Clean previous builds
          rm -rf .buildozer bin
          
          # Update buildozer.spec version
          sed -i "s/^version = .*/version = ${{ steps.version.outputs.VERSION }}/" buildozer.spec
          
          # Set Android SDK environment variables
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          export PATH=$ANDROID_HOME/platform-tools:$PATH
          
          # Build APK
          buildozer -v android debug
      
      - name: Rename APK
        run: |
          # Find and rename the APK
          APK_PATH=$(find src/apps/android/bin -name "*.apk" -type f | head -n 1)
          if [ -f "$APK_PATH" ]; then
            cp "$APK_PATH" winvora-${{ steps.version.outputs.VERSION }}-android.apk
            echo "APK created successfully"
          else
            echo "No APK found"
            exit 1
          fi
      
      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-builds
          path: |
            winvora-*-android.apk

  create-release:
    needs: [build-linux, build-macos, build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: List downloaded files
        run: |
          echo "Downloaded artifacts:"
          find . -type f
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linux-builds/winvora-*-linux-x86_64
            linux-builds/winvora-*-linux-x86_64.AppImage
            linux-builds/winvora-*-linux-amd64.deb
            macos-builds/winvora-*-macos.dmg
            android-builds/winvora-*-android.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
